<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RISA Labs - Market Intelligence Hub</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root {
  --bg: #0f1117; --bg2: #161822; --bg3: #1e2030; --bg4: #262940;
  --text: #e0e0ee; --text2: #9499b3; --accent: #6c5ce7; --accent2: #a29bfe;
  --green: #00cec9; --red: #ff7675; --orange: #fdcb6e; --border: #2d3154;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'Inter','SF Pro',system-ui,sans-serif; background:var(--bg); color:var(--text); display:flex; height:100vh; overflow:hidden; }

/* Sidebar */
.sidebar { width:220px; background:var(--bg2); border-right:1px solid var(--border); display:flex; flex-direction:column; flex-shrink:0; }
.logo { padding:20px 16px; border-bottom:1px solid var(--border); }
.logo h1 { font-size:18px; color:var(--accent2); letter-spacing:1px; }
.logo p { font-size:11px; color:var(--text2); margin-top:4px; }
.nav { flex:1; padding:12px 0; }
.nav a { display:flex; align-items:center; gap:10px; padding:10px 16px; color:var(--text2); text-decoration:none; font-size:14px; cursor:pointer; transition:all .15s; }
.nav a:hover, .nav a.active { color:var(--text); background:var(--bg3); border-left:3px solid var(--accent); }
.nav a .icon { font-size:18px; width:24px; text-align:center; }
.nav-divider { height:1px; background:var(--border); margin:8px 16px; }
.stats { padding:16px; border-top:1px solid var(--border); font-size:12px; color:var(--text2); }
.stats .stat { margin:4px 0; }
.stats .stat span { color:var(--accent2); font-weight:600; }

/* Main */
.main { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.topbar { display:flex; align-items:center; justify-content:space-between; padding:12px 24px; border-bottom:1px solid var(--border); background:var(--bg2); flex-shrink:0; }
.topbar h2 { font-size:16px; font-weight:500; }
.topbar .actions { display:flex; gap:8px; }
.topbar .actions button { background:var(--bg3); border:1px solid var(--border); color:var(--text2); padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; }
.topbar .actions button:hover { background:var(--bg4); color:var(--text); }
.content { flex:1; overflow-y:auto; padding:24px; }

/* Chat Panel */
.chat-panel { width:380px; background:var(--bg2); border-left:1px solid var(--border); display:flex; flex-direction:column; flex-shrink:0; transition:width .2s; }
.chat-panel.collapsed { width:0; overflow:hidden; border:none; }
.chat-header { padding:12px 16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
.chat-header h3 { font-size:14px; color:var(--accent2); }
.chat-messages { flex:1; overflow-y:auto; padding:12px; }
.chat-msg { margin:8px 0; padding:10px 12px; border-radius:8px; font-size:13px; line-height:1.5; }
.chat-msg.user { background:var(--accent); color:#fff; margin-left:40px; }
.chat-msg.bot { background:var(--bg3); color:var(--text); margin-right:20px; }
.chat-msg.bot mark { background:var(--orange); color:#000; padding:0 2px; border-radius:2px; }
.chat-input { display:flex; gap:8px; padding:12px; border-top:1px solid var(--border); }
.chat-input input { flex:1; background:var(--bg3); border:1px solid var(--border); border-radius:6px; padding:8px 12px; color:var(--text); font-size:13px; outline:none; }
.chat-input input:focus { border-color:var(--accent); }
.chat-input button { background:var(--accent); border:none; color:#fff; padding:8px 16px; border-radius:6px; cursor:pointer; font-size:13px; }

/* Tables */
.data-table { width:100%; border-collapse:collapse; font-size:13px; }
.data-table th { background:var(--bg3); color:var(--accent2); padding:10px 12px; text-align:left; font-weight:500; position:sticky; top:0; }
.data-table td { padding:8px 12px; border-bottom:1px solid var(--border); color:var(--text2); }
.data-table tr:hover td { background:var(--bg3); color:var(--text); }

/* Filters */
.filters { display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
.filters select, .filters input { background:var(--bg3); border:1px solid var(--border); color:var(--text); padding:8px 12px; border-radius:6px; font-size:13px; outline:none; }
.filters select:focus, .filters input:focus { border-color:var(--accent); }

/* Cards */
.card-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:16px; }
.card { background:var(--bg3); border:1px solid var(--border); border-radius:8px; padding:16px; }
.card h4 { color:var(--accent2); font-size:14px; margin-bottom:8px; }
.card p { font-size:12px; color:var(--text2); line-height:1.6; }
.card .tag { display:inline-block; background:var(--bg4); color:var(--accent2); padding:2px 8px; border-radius:10px; font-size:11px; margin:4px 4px 0 0; }

/* Viz links */
.viz-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:16px; }
.viz-card { background:var(--bg3); border:1px solid var(--border); border-radius:8px; padding:20px; text-align:center; cursor:pointer; transition:all .15s; }
.viz-card:hover { border-color:var(--accent); transform:translateY(-2px); }
.viz-card .icon { font-size:36px; margin-bottom:12px; }
.viz-card h4 { color:var(--text); margin-bottom:4px; }
.viz-card p { font-size:12px; color:var(--text2); }

/* Search results */
.search-result { background:var(--bg3); border:1px solid var(--border); border-radius:8px; padding:14px; margin-bottom:10px; }
.search-result .source { font-size:11px; color:var(--accent2); margin-bottom:4px; }
.search-result .heading { font-size:13px; color:var(--text); font-weight:500; }
.search-result .snippet { font-size:12px; color:var(--text2); margin-top:6px; line-height:1.5; }

/* Market Map - Category Groups */
.category-group { margin-bottom:20px; border:1px solid var(--border); border-radius:10px; overflow:hidden; background:var(--bg2); }
.category-header { display:flex; align-items:center; justify-content:space-between; padding:14px 20px; background:var(--bg3); cursor:pointer; user-select:none; transition:background .15s; }
.category-header:hover { background:var(--bg4); }
.category-header h3 { font-size:15px; font-weight:600; color:var(--text); display:flex; align-items:center; gap:8px; }
.category-header .count { font-size:12px; color:var(--text2); background:var(--bg); padding:2px 8px; border-radius:10px; }
.category-header .chevron { color:var(--text2); font-size:12px; transition:transform .2s; }
.category-header.open .chevron { transform:rotate(90deg); }
.category-body { display:none; padding:16px 20px; }
.category-body.open { display:block; }
.segment-card { background:var(--bg3); border:1px solid var(--border); border-radius:8px; padding:16px 20px; margin-bottom:12px; transition:border-color .15s; }
.segment-card:last-child { margin-bottom:0; }
.segment-card:hover { border-color:var(--accent); }
.segment-card h4 { color:var(--accent2); font-size:14px; margin-bottom:10px; }
.segment-card .seg-row { display:flex; gap:12px; margin-bottom:6px; font-size:12px; line-height:1.6; }
.segment-card .seg-row:last-child { margin-bottom:0; }
.segment-card .seg-label { color:var(--text2); font-weight:600; min-width:110px; flex-shrink:0; }
.segment-card .seg-value { color:var(--text2); }
.segment-card .seg-value.opportunity { color:var(--green); font-weight:500; }
.segment-card .seg-description { font-size:12px; color:var(--text2); margin-bottom:10px; font-style:italic; }
.segment-card .seg-pills { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
.segment-card .seg-pill { font-size:10px; padding:3px 8px; border-radius:10px; background:var(--bg4); color:var(--text2); }
.segment-card .seg-pill.pain { background:rgba(255,118,117,0.15); color:var(--red); }
.segment-card .seg-pill.opp { background:rgba(0,206,201,0.15); color:var(--green); }

/* Center Detail Modal */
.modal-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1000; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
.modal { background:var(--bg2); border:1px solid var(--border); border-radius:12px; width:90%; max-width:800px; max-height:90vh; overflow-y:auto; }
.modal-header { display:flex; justify-content:space-between; align-items:flex-start; padding:24px 28px 16px; border-bottom:1px solid var(--border); position:sticky; top:0; background:var(--bg2); z-index:1; border-radius:12px 12px 0 0; }
.modal-header h2 { font-size:20px; color:var(--text); font-weight:600; }
.modal-header .sub { font-size:13px; color:var(--text2); margin-top:4px; }
.modal-close { background:none; border:none; color:var(--text2); font-size:24px; cursor:pointer; padding:0 4px; line-height:1; }
.modal-close:hover { color:var(--text); }
.modal-body { padding:24px 28px; }
.detail-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px 24px; margin-bottom:24px; }
.detail-item { }
.detail-item .label { font-size:11px; color:var(--text2); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px; }
.detail-item .value { font-size:14px; color:var(--text); }
.detail-item .value a { color:var(--accent2); text-decoration:none; }
.detail-item .value a:hover { text-decoration:underline; }
.detail-item .value.empty { color:var(--text2); font-style:italic; font-size:13px; }
.detail-item.full { grid-column:1 / -1; }
.detail-section { margin-top:24px; padding-top:20px; border-top:1px solid var(--border); }
.detail-section h3 { font-size:14px; color:var(--accent2); margin-bottom:12px; display:flex; align-items:center; gap:8px; }
.notes-textarea { width:100%; min-height:120px; background:var(--bg3); border:1px solid var(--border); border-radius:8px; color:var(--text); padding:12px; font-size:13px; font-family:inherit; line-height:1.6; resize:vertical; outline:none; }
.notes-textarea:focus { border-color:var(--accent); }
.notes-actions { display:flex; gap:8px; margin-top:10px; align-items:center; }
.notes-actions button { padding:8px 16px; border-radius:6px; font-size:13px; cursor:pointer; border:none; }
.btn-save { background:var(--accent); color:#fff; }
.btn-save:hover { background:var(--accent2); }
.btn-save:disabled { opacity:0.5; cursor:not-allowed; }
.notes-status { font-size:12px; color:var(--green); }
.badge-340b { display:inline-block; background:rgba(0,206,201,0.15); color:var(--green); padding:2px 8px; border-radius:10px; font-size:12px; }
.badge-no { display:inline-block; background:rgba(255,118,117,0.15); color:var(--red); padding:2px 8px; border-radius:10px; font-size:12px; }

/* Clickable rows */
.data-table tbody tr { cursor:pointer; }

/* Map View */
#view-map { padding:0 !important; position:relative; }
#mapContainer { width:100%; height:100%; }
.map-panel { position:absolute; top:12px; right:12px; z-index:1000; width:280px; background:rgba(22,24,34,0.92); border:1px solid var(--border); border-radius:10px; backdrop-filter:blur(8px); max-height:calc(100% - 24px); overflow-y:auto; transition:transform .2s; }
.map-panel.collapsed .map-panel-body { display:none; }
.map-panel-header { display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-bottom:1px solid var(--border); cursor:pointer; }
.map-panel-header h3 { font-size:13px; color:var(--accent2); }
.map-panel-body { padding:12px 14px; }
.map-section { margin-bottom:14px; }
.map-section h4 { font-size:11px; color:var(--text2); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; }
.map-bar { display:flex; align-items:center; gap:8px; margin-bottom:4px; font-size:12px; }
.map-bar .bar-fill { height:8px; border-radius:4px; min-width:4px; }
.map-bar .bar-label { color:var(--text2); flex:1; }
.map-bar .bar-count { color:var(--text); font-weight:600; min-width:24px; text-align:right; }
.map-filter-group { margin-bottom:10px; }
.map-filter-group label { display:flex; align-items:center; gap:6px; font-size:12px; color:var(--text2); cursor:pointer; margin-bottom:4px; }
.map-filter-group label input { accent-color:var(--accent); }
.map-filter-group select { width:100%; background:var(--bg3); border:1px solid var(--border); color:var(--text); padding:6px 8px; border-radius:6px; font-size:12px; }
.map-stat-big { text-align:center; padding:8px; background:var(--bg3); border-radius:8px; margin-bottom:8px; }
.map-stat-big .num { font-size:24px; font-weight:700; color:var(--accent2); }
.map-stat-big .lbl { font-size:11px; color:var(--text2); }
.leaflet-popup-content-wrapper { background:var(--bg2) !important; color:var(--text) !important; border:1px solid var(--border) !important; border-radius:8px !important; }
.leaflet-popup-tip { background:var(--bg2) !important; }
.leaflet-popup-content { font-size:12px; line-height:1.6; margin:10px 14px !important; }
.leaflet-popup-content a { color:var(--accent2); }
.leaflet-popup-content strong { color:var(--accent2); }
.leaflet-container { background:var(--bg) !important; }

/* People view */
.people-stats { display:flex; gap:16px; margin-bottom:16px; }
.people-stat-card { background:var(--bg3); border:1px solid var(--border); border-radius:8px; padding:14px 20px; flex:1; text-align:center; }
.people-stat-card .num { font-size:24px; font-weight:700; color:var(--accent2); }
.people-stat-card .lbl { font-size:11px; color:var(--text2); margin-top:2px; }
.relevance-badge { display:inline-block; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:600; }
.relevance-badge.decision-maker { background:rgba(255,118,117,0.2); color:var(--red); }
.relevance-badge.influencer { background:rgba(253,203,110,0.2); color:var(--orange); }
.relevance-badge.champion { background:rgba(0,206,201,0.2); color:var(--green); }
.relevance-badge.network { background:rgba(108,92,231,0.2); color:var(--accent2); }
.relevance-badge.blocker { background:rgba(255,118,117,0.35); color:#ff5252; }
.linkedin-link { color:var(--accent2); text-decoration:none; font-size:16px; }
.linkedin-link:hover { color:var(--text); }

/* Form modal */
.form-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px 20px; }
.form-group { display:flex; flex-direction:column; gap:4px; }
.form-group.full { grid-column:1 / -1; }
.form-group label { font-size:11px; color:var(--text2); text-transform:uppercase; letter-spacing:0.5px; }
.form-group input, .form-group select, .form-group textarea {
  background:var(--bg3); border:1px solid var(--border); border-radius:6px; color:var(--text);
  padding:8px 12px; font-size:13px; font-family:inherit; outline:none;
}
.form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color:var(--accent); }
.form-group textarea { min-height:80px; resize:vertical; }
.form-actions { display:flex; gap:8px; margin-top:18px; justify-content:flex-end; }
.form-actions button { padding:8px 20px; border-radius:6px; font-size:13px; cursor:pointer; border:none; }
.btn-primary { background:var(--accent); color:#fff; }
.btn-primary:hover { background:var(--accent2); }
.btn-danger { background:var(--red); color:#fff; }
.btn-danger:hover { opacity:0.8; }
.btn-secondary { background:var(--bg4); color:var(--text2); }
.btn-secondary:hover { color:var(--text); }

/* People in center modal */
.center-people-table { width:100%; border-collapse:collapse; font-size:12px; margin-top:8px; }
.center-people-table th { background:var(--bg); color:var(--text2); padding:6px 8px; text-align:left; font-weight:500; }
.center-people-table td { padding:6px 8px; border-bottom:1px solid var(--border); color:var(--text2); }
.center-people-table tr:hover td { color:var(--text); }

.hidden { display:none; }
.badge { background:var(--accent); color:#fff; font-size:10px; padding:2px 6px; border-radius:8px; margin-left:6px; }
</style>
</head>
<body>

<div class="sidebar">
  <div class="logo">
    <h1>RISA LABS</h1>
    <p>Market Intelligence Hub</p>
  </div>
  <div class="nav">
    <a class="active" data-view="centers"><span class="icon">üè•</span>Cancer Centers</a>
    <a data-view="map"><span class="icon">üìç</span>Map</a>
    <a data-view="segments"><span class="icon">üó∫Ô∏è</span>Market Map</a>
    <a data-view="orgs"><span class="icon">üè¢</span>Organizations</a>
    <a data-view="people"><span class="icon">üë•</span>People</a>
    <a data-view="workflows"><span class="icon">‚öôÔ∏è</span>Workflows</a>
    <div class="nav-divider"></div>
    <a data-view="viz"><span class="icon">üìä</span>Visualizations</a>
    <a data-view="search"><span class="icon">üîç</span>Full Search</a>
  </div>
  <div class="stats" id="stats">
    <div class="stat">Loading stats...</div>
  </div>
</div>

<div class="main">
  <div class="topbar">
    <h2 id="viewTitle">Cancer Centers</h2>
    <div class="actions">
      <button onclick="toggleChat()">üí¨ Chat</button>
    </div>
  </div>

  <!-- Centers View -->
  <div class="content" id="view-centers">
    <div class="filters">
      <select id="filterState" onchange="loadCenters()">
        <option value="">All States</option>
        <option value="CA">California</option>
        <option value="FL">Florida</option>
        <option value="MA">Massachusetts</option>
        <option value="NY">New York</option>
        <option value="TX">Texas</option>
        <option value="WA">Washington</option>
      </select>
      <select id="filterCategory" onchange="loadCenters()">
        <option value="">All Categories</option>
        <option value="NCI">NCI-Designated</option>
        <option value="Academic">Academic</option>
        <option value="Community">Community</option>
        <option value="Hospital">Hospital System</option>
        <option value="Specialty">Specialty/Boutique</option>
      </select>
      <input type="text" id="filterSearch" placeholder="Search centers..." oninput="loadCenters()">
    </div>
    <div style="overflow-x:auto;">
      <table class="data-table">
        <thead>
          <tr><th>Name</th><th>City</th><th>State</th><th>Category</th><th>Parent Org</th><th>EHR</th><th>Est. Oncologists</th><th>Website</th></tr>
        </thead>
        <tbody id="centersBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Market Segments View -->
  <div class="content hidden" id="view-segments">
    <div class="filters">
      <input type="text" id="segSearch" placeholder="Search segments..." oninput="loadSegments()">
      <button onclick="expandAll()" style="background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:8px 12px;border-radius:6px;cursor:pointer;font-size:13px;">Expand All</button>
      <button onclick="collapseAll()" style="background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:8px 12px;border-radius:6px;cursor:pointer;font-size:13px;">Collapse All</button>
    </div>
    <div id="segmentsGrid"></div>
  </div>

  <!-- Organizations View -->
  <div class="content hidden" id="view-orgs">
    <div class="filters">
      <select id="orgType" onchange="loadOrgs()">
        <option value="">All Types</option>
        <option value="Pharma">Pharma</option>
        <option value="Technology">Technology</option>
        <option value="Payer">Payer</option>
        <option value="Diagnostics">Diagnostics</option>
        <option value="Distributor">Distributor</option>
        <option value="Regulatory/Guidelines">Regulatory</option>
      </select>
      <input type="text" id="orgSearch" placeholder="Search organizations..." oninput="loadOrgs()">
    </div>
    <div style="overflow-x:auto;">
      <table class="data-table">
        <thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead>
        <tbody id="orgsBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Visualizations View -->
  <div class="content hidden" id="view-viz">
    <div class="viz-grid">
      <div class="viz-card" onclick="window.open('/viz/oncology-money-flows.html','_blank')">
        <div class="icon">üí∞</div><h4>Oncology Money Flows</h4><p>Interactive financial flow visualization</p>
      </div>
      <div class="viz-card" onclick="window.open('/viz/oncology-workflows.html','_blank')">
        <div class="icon">üîÑ</div><h4>Oncology Workflows</h4><p>Prior auth, claims, billing workflows</p>
      </div>
      <div class="viz-card" onclick="window.open('/viz/cancer-centers.html','_blank')">
        <div class="icon">üè•</div><h4>Cancer Centers Map</h4><p>Geographic visualization of centers</p>
      </div>
      <div class="viz-card" onclick="window.open('/viz/us-oncology-mindmap.html','_blank')">
        <div class="icon">üß†</div><h4>US Oncology Mind Map</h4><p>Full ecosystem mind map</p>
      </div>
    </div>
  </div>

  <!-- Map View -->
  <div class="content hidden" id="view-map">
    <div id="mapContainer"></div>
    <div class="map-panel" id="mapPanel">
      <div class="map-panel-header" onclick="document.getElementById('mapPanel').classList.toggle('collapsed')">
        <h3>Analytics</h3>
        <span style="color:var(--text2);font-size:12px;">&#9660;</span>
      </div>
      <div class="map-panel-body">
        <div class="map-stat-big">
          <div class="num" id="mapTotal">-</div>
          <div class="lbl">Cancer Centers</div>
        </div>
        <div class="map-section">
          <h4>Filters</h4>
          <div class="map-filter-group">
            <select id="mapStateFilter" onchange="applyMapFilters()">
              <option value="">All States</option>
              <option value="CA">California</option>
              <option value="FL">Florida</option>
              <option value="MA">Massachusetts</option>
              <option value="NY">New York</option>
              <option value="TX">Texas</option>
              <option value="WA">Washington</option>
            </select>
          </div>
          <div class="map-filter-group" id="mapCategoryFilters"></div>
        </div>
        <div class="map-section">
          <h4>By State</h4>
          <div id="mapStateBreakdown"></div>
        </div>
        <div class="map-section">
          <h4>By Category</h4>
          <div id="mapCatBreakdown"></div>
        </div>
        <div class="map-section">
          <h4>EHR Vendors</h4>
          <div id="mapEhrBreakdown"></div>
        </div>
        <div class="map-section">
          <h4>340B Participation</h4>
          <div id="map340b"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- People View -->
  <div class="content hidden" id="view-people">
    <div class="people-stats">
      <div class="people-stat-card"><div class="num" id="peopleTotalStat">-</div><div class="lbl">Total People</div></div>
      <div class="people-stat-card"><div class="num" id="peopleDecisionStat">-</div><div class="lbl">Decision Makers</div></div>
      <div class="people-stat-card"><div class="num" id="peopleCentersStat">-</div><div class="lbl">Centers Covered</div></div>
    </div>
    <div class="filters">
      <select id="peopleRoleFilter" onchange="loadPeople()">
        <option value="">All Roles</option>
        <option value="C-Suite">C-Suite</option>
        <option value="VP">VP</option>
        <option value="Director">Director</option>
        <option value="Clinical">Clinical</option>
        <option value="IT">IT</option>
        <option value="Finance">Finance</option>
        <option value="Practice Admin">Practice Admin</option>
      </select>
      <select id="peopleDeptFilter" onchange="loadPeople()">
        <option value="">All Departments</option>
        <option value="Oncology">Oncology</option>
        <option value="Revenue Cycle">Revenue Cycle</option>
        <option value="IT">IT</option>
        <option value="Administration">Administration</option>
        <option value="Clinical Ops">Clinical Ops</option>
        <option value="Finance">Finance</option>
      </select>
      <select id="peopleRelFilter" onchange="loadPeople()">
        <option value="">All Relevance</option>
        <option value="Decision Maker">Decision Maker</option>
        <option value="Influencer">Influencer</option>
        <option value="Champion">Champion</option>
        <option value="Network">Network</option>
      </select>
      <input type="text" id="peopleSearch" placeholder="Search name, title, org..." oninput="loadPeople()">
      <button onclick="openPersonForm()" style="background:var(--accent);border:none;color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;">+ Add Person</button>
    </div>
    <div style="overflow-x:auto;">
      <table class="data-table">
        <thead>
          <tr><th>Name</th><th>Title</th><th>Organization</th><th>Role Type</th><th>Department</th><th>Relevance</th><th>LinkedIn</th></tr>
        </thead>
        <tbody id="peopleBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Workflows View -->
  <div class="content hidden" id="view-workflows">
    <div class="people-stats" id="wfStats">
      <div class="people-stat-card"><div class="num" id="wfTotal">-</div><div class="lbl">Total Workflows</div></div>
      <div class="people-stat-card"><div class="num" id="wfSteps">-</div><div class="lbl">Total Steps</div></div>
      <div class="people-stat-card"><div class="num" id="wfAutoPct">-</div><div class="lbl">% Automatable</div></div>
      <div class="people-stat-card"><div class="num" id="wfAvgBn">-</div><div class="lbl">Avg Bottleneck</div></div>
    </div>
    <div class="filters">
      <select id="wfDeptFilter" onchange="loadWorkflows()">
        <option value="">All Departments</option>
        <option value="Patient Access">Patient Access</option>
        <option value="Clinical Ops">Clinical Ops</option>
        <option value="BMT/Cell Therapy">BMT/Cell Therapy</option>
        <option value="RCM">RCM</option>
        <option value="Research">Research</option>
        <option value="Quality">Quality</option>
        <option value="Admin">Admin</option>
      </select>
      <select id="wfStageFilter" onchange="loadWorkflows()">
        <option value="">All Stages</option>
        <option value="1">1 - Referral & Access</option>
        <option value="2">2 - Intake & Registration</option>
        <option value="3">3 - Diagnosis & Staging</option>
        <option value="4">4 - Treatment Planning</option>
        <option value="5">5 - Active Treatment</option>
        <option value="6">6 - Monitoring & Response</option>
        <option value="7">7 - Survivorship & Follow-Up</option>
        <option value="8">8 - End of Life / Palliative</option>
        <option value="9">9 - Behind the Scenes</option>
      </select>
      <select id="wfComplexFilter" onchange="loadWorkflows()">
        <option value="">All Complexity</option>
        <option value="High">High</option>
        <option value="Medium">Medium</option>
        <option value="Low">Low</option>
      </select>
      <select id="wfCenterFilter" onchange="loadWorkflows()">
        <option value="">All Centers</option>
        <option value="TX">Texas Oncology</option>
        <option value="ST">Stanford</option>
        <option value="FH">Fred Hutch</option>
      </select>
      <input type="text" id="wfSearch" placeholder="Search workflows..." oninput="loadWorkflows()">
    </div>
    <div style="display:flex;gap:8px;margin-bottom:16px;">
      <button onclick="setWfView('table')" id="wfViewTable" style="background:var(--accent);border:none;color:#fff;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;">Table</button>
      <button onclick="setWfView('cards')" id="wfViewCards" style="background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;">Cards</button>
      <button onclick="setWfView('journey')" id="wfViewJourney" style="background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;">Journey Map</button>
      <span style="margin-left:auto;font-size:12px;color:var(--text2);align-self:center;" id="wfCount"></span>
    </div>
    <div id="wfTableView" style="overflow-x:auto;">
      <table class="data-table">
        <thead>
          <tr><th>ID</th><th>Workflow</th><th>Department</th><th>Stage</th><th>Centers</th><th>Complexity</th><th>Bottleneck</th><th>Time (min)</th></tr>
        </thead>
        <tbody id="wfBody"></tbody>
      </table>
    </div>
    <div id="wfCardsView" class="hidden">
      <div class="card-grid" id="wfCardsGrid"></div>
    </div>
    <div id="wfJourneyView" class="hidden">
      <div id="wfJourneyMap"></div>
    </div>
  </div>

  <!-- Workflow Detail Modal -->
  <div class="modal-overlay hidden" id="wfModal" onclick="if(event.target===this)closeWfModal()">
    <div class="modal" style="max-width:900px;">
      <div class="modal-header">
        <div>
          <h2 id="wfModalName"></h2>
          <div class="sub" id="wfModalSub"></div>
        </div>
        <button class="modal-close" onclick="closeWfModal()">&times;</button>
      </div>
      <div class="modal-body" id="wfModalBody"></div>
    </div>
  </div>

  <!-- Search View -->
  <div class="content hidden" id="view-search">
    <div class="filters">
      <input type="text" id="fullSearch" placeholder="Search across all content..." style="flex:1;min-width:300px;"
             onkeydown="if(event.key==='Enter')doSearch()">
      <button onclick="doSearch()" style="background:var(--accent);border:none;color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer;">Search</button>
    </div>
    <div id="searchResults"></div>
  </div>
</div>

<!-- Center Detail Modal -->
<div class="modal-overlay hidden" id="centerModal" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-header">
      <div>
        <h2 id="modalName"></h2>
        <div class="sub" id="modalSub"></div>
      </div>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<!-- Person Detail Modal -->
<div class="modal-overlay hidden" id="personModal" onclick="if(event.target===this)closePersonModal()">
  <div class="modal">
    <div class="modal-header">
      <div>
        <h2 id="personModalName"></h2>
        <div class="sub" id="personModalSub"></div>
      </div>
      <button class="modal-close" onclick="closePersonModal()">&times;</button>
    </div>
    <div class="modal-body" id="personModalBody"></div>
  </div>
</div>

<!-- Person Form Modal -->
<div class="modal-overlay hidden" id="personFormModal" onclick="if(event.target===this)closePersonForm()">
  <div class="modal" style="max-width:700px;">
    <div class="modal-header">
      <div><h2 id="personFormTitle">Add Person</h2></div>
      <button class="modal-close" onclick="closePersonForm()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>Name *</label><input type="text" id="pf_name"></div>
        <div class="form-group"><label>Title</label><input type="text" id="pf_title"></div>
        <div class="form-group"><label>Role Type</label>
          <select id="pf_role_type"><option value="">Select...</option><option>C-Suite</option><option>VP</option><option>Director</option><option>Clinical</option><option>IT</option><option>Finance</option><option>Practice Admin</option><option>Other</option></select>
        </div>
        <div class="form-group"><label>Organization</label><input type="text" id="pf_organization" list="orgSuggestions"><datalist id="orgSuggestions"></datalist></div>
        <div class="form-group"><label>Department</label>
          <select id="pf_department"><option value="">Select...</option><option>Oncology</option><option>Revenue Cycle</option><option>IT</option><option>Administration</option><option>Clinical Ops</option><option>Finance</option></select>
        </div>
        <div class="form-group"><label>Relevance to RISA</label>
          <select id="pf_relevance"><option value="">Select...</option><option>Decision Maker</option><option>Influencer</option><option>Champion</option><option>Blocker</option><option>Network</option></select>
        </div>
        <div class="form-group"><label>Email</label><input type="email" id="pf_email"></div>
        <div class="form-group"><label>Phone</label><input type="text" id="pf_phone"></div>
        <div class="form-group"><label>LinkedIn URL</label><input type="text" id="pf_linkedin"></div>
        <div class="form-group"><label>Source</label>
          <select id="pf_source"><option value="">Select...</option><option>Website</option><option>LinkedIn</option><option>Conference</option><option>Referral</option><option>Manual</option></select>
        </div>
        <div class="form-group"><label>Last Contacted</label><input type="date" id="pf_last_contacted"></div>
        <div class="form-group"><label>Next Follow-up</label><input type="date" id="pf_next_followup"></div>
        <div class="form-group full"><label>Notes</label><textarea id="pf_notes"></textarea></div>
      </div>
      <input type="hidden" id="pf_center_id">
      <input type="hidden" id="pf_edit_id">
      <div class="form-actions">
        <button class="btn-secondary" onclick="closePersonForm()">Cancel</button>
        <button class="btn-primary" onclick="savePerson()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Chat Panel -->
<div class="chat-panel" id="chatPanel">
  <div class="chat-header">
    <h3>üí¨ Ask about the market</h3>
    <button onclick="toggleChat()" style="background:none;border:none;color:var(--text2);cursor:pointer;font-size:16px;">‚úï</button>
  </div>
  <div class="chat-messages" id="chatMessages">
    <div class="chat-msg bot">Welcome! Ask me anything about oncology cancer centers, market segments, payers, or RISA Labs opportunities.</div>
  </div>
  <div class="chat-input">
    <input id="chatInput" placeholder="Ask a question..." onkeydown="if(event.key==='Enter')sendChat()">
    <button onclick="sendChat()">Send</button>
  </div>
</div>

<script>
const API = '';

// Navigation
document.querySelectorAll('.nav a').forEach(a => {
  a.addEventListener('click', () => {
    document.querySelectorAll('.nav a').forEach(x => x.classList.remove('active'));
    a.classList.add('active');
    const view = a.dataset.view;
    document.querySelectorAll('.content').forEach(c => c.classList.add('hidden'));
    document.getElementById('view-' + view).classList.remove('hidden');
    document.getElementById('viewTitle').textContent = a.textContent.trim();
    if (view === 'people') { loadPeople(); }
    if (view === 'workflows') { loadWorkflowStats(); loadWorkflows(); }
    if (view === 'map') {
      setTimeout(function() {
        initMap();
        if (mapInstance) mapInstance.invalidateSize();
      }, 100);
    }
  });
});

// Load Centers
async function loadCenters() {
  const state = document.getElementById('filterState').value;
  const cat = document.getElementById('filterCategory').value;
  const search = document.getElementById('filterSearch').value;
  const params = new URLSearchParams();
  if (state) params.set('state', state);
  if (cat) params.set('category', cat);
  if (search) params.set('search', search);
  const res = await fetch(API + '/api/centers?' + params);
  const data = await res.json();
  const tbody = document.getElementById('centersBody');
  tbody.innerHTML = data.centers.map(c => `<tr onclick="openCenter(${c.id})">
    <td><strong style="color:var(--accent2)">${esc(c.name)}</strong></td>
    <td>${esc(c.city)}</td>
    <td>${esc(c.state)}</td>
    <td>${esc(c.category)}</td>
    <td>${esc(c.parent_org)}</td>
    <td>${esc(c.ehr_vendor)}</td>
    <td>${esc(c.est_oncologists)}</td>
    <td>${c.website && c.website !== '-' ? '<a href="https://'+esc(c.website)+'" target="_blank" style="color:var(--accent2)" onclick="event.stopPropagation()">'+esc(c.website)+'</a>' : '-'}</td>
  </tr>`).join('');
}

// Load Segments
async function loadSegments() {
  const search = document.getElementById('segSearch').value;
  const params = new URLSearchParams();
  if (search) params.set('search', search);
  const res = await fetch(API + '/api/segments?' + params);
  const data = await res.json();
  const grid = document.getElementById('segmentsGrid');

  // Group by category
  const groups = {};
  data.segments.forEach(s => {
    const cat = s.category || 'Uncategorized';
    if (!groups[cat]) groups[cat] = [];
    groups[cat].push(s);
  });

  const catColors = {
    'CARE DELIVERY': '#6c5ce7',
    'PAYERS': '#00cec9',
    'PHARMA': '#fd79a8',
    'DIAGNOSTICS': '#00b894',
    'CLINICAL TRIALS': '#e17055',
    'TECHNOLOGY': '#0984e3',
    'REGULATORS': '#636e72',
    'PATIENTS': '#fdcb6e',
    'FINANCIAL': '#d63031'
  };

  function getCatColor(cat) {
    for (const [key, color] of Object.entries(catColors)) {
      if (cat.toUpperCase().includes(key)) return color;
    }
    return '#6c5ce7';
  }

  grid.innerHTML = Object.entries(groups).map(([cat, segments]) => {
    const color = getCatColor(cat);
    const cards = segments.map(s => `
      <div class="segment-card">
        <h4>${esc(s.segment_name)}</h4>
        ${s.description ? '<div class="seg-description">'+esc(s.description).replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')+'</div>' : ''}
        ${s.role ? '<div class="seg-row"><span class="seg-label">Role</span><span class="seg-value">'+esc(s.role)+'</span></div>' : ''}
        ${s.pain_points ? '<div class="seg-row"><span class="seg-label">Pain Points</span><span class="seg-value pain">'+esc(s.pain_points)+'</span></div>' : ''}
        ${s.risa_opportunity ? '<div class="seg-row"><span class="seg-label">RISA Opportunity</span><span class="seg-value opportunity">'+esc(s.risa_opportunity)+'</span></div>' : ''}
        ${s.money_flow ? '<div class="seg-row"><span class="seg-label">Money Flow</span><span class="seg-value">'+esc(s.money_flow)+'</span></div>' : ''}
        ${s.data_flow ? '<div class="seg-row"><span class="seg-label">Data Flow</span><span class="seg-value">'+esc(s.data_flow)+'</span></div>' : ''}
      </div>
    `).join('');

    return `
      <div class="category-group">
        <div class="category-header" onclick="toggleCategory(this)" style="border-left:4px solid ${color}">
          <h3>${esc(cat)} <span class="count">${segments.length}</span></h3>
          <span class="chevron">&#9654;</span>
        </div>
        <div class="category-body">${cards}</div>
      </div>
    `;
  }).join('');
}

function toggleCategory(el) {
  el.classList.toggle('open');
  el.nextElementSibling.classList.toggle('open');
}
function expandAll() {
  document.querySelectorAll('.category-header').forEach(h => { h.classList.add('open'); h.nextElementSibling.classList.add('open'); });
}
function collapseAll() {
  document.querySelectorAll('.category-header').forEach(h => { h.classList.remove('open'); h.nextElementSibling.classList.remove('open'); });
}

// Load Organizations
async function loadOrgs() {
  const type = document.getElementById('orgType').value;
  const search = document.getElementById('orgSearch').value;
  const params = new URLSearchParams();
  if (type) params.set('type', type);
  if (search) params.set('search', search);
  const res = await fetch(API + '/api/organizations?' + params);
  const data = await res.json();
  const tbody = document.getElementById('orgsBody');
  tbody.innerHTML = data.organizations.map(o => `<tr>
    <td><strong>${esc(o.name)}</strong></td>
    <td><span class="tag">${esc(o.type)}</span></td>
    <td>${esc(o.description)}</td>
  </tr>`).join('');
}

// Full Search
async function doSearch() {
  const q = document.getElementById('fullSearch').value;
  if (!q) return;
  const res = await fetch(API + '/api/search?q=' + encodeURIComponent(q));
  const data = await res.json();
  const div = document.getElementById('searchResults');
  if (data.results.length === 0) {
    div.innerHTML = '<p style="color:var(--text2)">No results found.</p>';
    return;
  }
  div.innerHTML = data.results.map(r => `<div class="search-result">
    <div class="source">${esc(r.source_file)} ‚Üí ${esc(r.section_heading)}</div>
    <div class="snippet">${r.snippet}</div>
  </div>`).join('');
}

// Chat
function toggleChat() {
  document.getElementById('chatPanel').classList.toggle('collapsed');
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const q = input.value.trim();
  if (!q) return;
  input.value = '';
  const msgs = document.getElementById('chatMessages');
  msgs.innerHTML += `<div class="chat-msg user">${esc(q)}</div>`;
  msgs.innerHTML += `<div class="chat-msg bot" id="typing">Thinking...</div>`;
  msgs.scrollTop = msgs.scrollHeight;

  try {
    const res = await fetch(API + '/api/chat', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({question: q})
    });
    const data = await res.json();
    document.getElementById('typing').remove();
    // Simple markdown-to-html
    let answer = data.answer
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\n/g, '<br>');
    if (data.mode === 'search-fallback') {
      answer = '<em style="color:var(--orange)">[Search mode - LLM unavailable]</em><br>' + answer;
    }
    msgs.innerHTML += `<div class="chat-msg bot">${answer}</div>`;
  } catch(e) {
    document.getElementById('typing').remove();
    msgs.innerHTML += `<div class="chat-msg bot" style="color:var(--red)">Error: ${esc(e.message)}</div>`;
  }
  msgs.scrollTop = msgs.scrollHeight;
}

// Center Detail Modal
let currentCenterId = null;

async function openCenter(id) {
  const res = await fetch(API + '/api/centers/' + id);
  const c = await res.json();
  currentCenterId = id;

  document.getElementById('modalName').textContent = c.name;
  document.getElementById('modalSub').textContent = [c.city, c.state, c.category].filter(Boolean).join(' ¬∑ ');

  const v = (val, fallback) => val ? esc(String(val)) : '<span class="empty">' + (fallback || 'Not available') + '</span>';
  const badge340b = c.is_340b === 1 ? '<span class="badge-340b">Yes</span>' : c.is_340b === 0 ? '<span class="badge-no">No</span>' : '<span class="empty">Unknown</span>';

  document.getElementById('modalBody').innerHTML = `
    <div class="detail-grid">
      <div class="detail-item">
        <div class="label">Parent Organization</div>
        <div class="value">${v(c.parent_org)}</div>
      </div>
      <div class="detail-item">
        <div class="label">Health System</div>
        <div class="value">${v(c.health_system)}</div>
      </div>
      <div class="detail-item">
        <div class="label">NCI Designation</div>
        <div class="value">${v(c.nci_type)}</div>
      </div>
      <div class="detail-item">
        <div class="label">Category</div>
        <div class="value">${v(c.category)}</div>
      </div>
      <div class="detail-item">
        <div class="label">EHR System</div>
        <div class="value">${v(c.ehr_vendor)}</div>
      </div>
      <div class="detail-item">
        <div class="label">Est. Oncologists</div>
        <div class="value">${v(c.est_oncologists)}</div>
      </div>
      <div class="detail-item">
        <div class="label">Bed Count</div>
        <div class="value">${c.bed_count ? c.bed_count.toLocaleString() : '<span class="empty">Not available</span>'}</div>
      </div>
      <div class="detail-item">
        <div class="label">340B Program</div>
        <div class="value">${badge340b}</div>
      </div>
      <div class="detail-item">
        <div class="label">Annual Cancer Cases</div>
        <div class="value">${c.annual_cancer_cases ? c.annual_cancer_cases.toLocaleString() + '/year' : '<span class="empty">Not available</span>'}</div>
      </div>
      <div class="detail-item">
        <div class="label">Website</div>
        <div class="value">${c.website ? '<a href="https://'+esc(c.website)+'" target="_blank">'+esc(c.website)+'</a>' : '<span class="empty">Not available</span>'}</div>
      </div>
    </div>

    <div class="detail-section">
      <h3>üìù Notes</h3>
      <textarea class="notes-textarea" id="notesArea" placeholder="Add notes about this center - meeting notes, contacts, intel, opportunities...">${esc(c.notes || '')}</textarea>
      <div class="notes-actions">
        <button class="btn-save" id="saveNotesBtn" onclick="saveNotes()">Save Notes</button>
        <span class="notes-status" id="notesStatus"></span>
      </div>
    </div>

    <div class="detail-section">
      <h3>üë• Key People at ${esc(c.name)}</h3>
      <div id="centerPeopleSection">Loading...</div>
    </div>
  `;

  document.getElementById('centerModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';

  // Load people for this center
  loadCenterPeople(id, c.name).then(function(html) {
    document.getElementById('centerPeopleSection').innerHTML = html;
  });
}

function closeModal() {
  document.getElementById('centerModal').classList.add('hidden');
  document.body.style.overflow = '';
  currentCenterId = null;
}

async function saveNotes() {
  const btn = document.getElementById('saveNotesBtn');
  const status = document.getElementById('notesStatus');
  const notes = document.getElementById('notesArea').value;
  btn.disabled = true;
  btn.textContent = 'Saving...';
  status.textContent = '';

  try {
    const res = await fetch(API + '/api/centers/' + currentCenterId + '/notes', {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({notes: notes})
    });
    const data = await res.json();
    if (data.ok) {
      status.textContent = '‚úì Saved';
      status.style.color = 'var(--green)';
    } else {
      status.textContent = 'Error saving';
      status.style.color = 'var(--red)';
    }
  } catch(e) {
    status.textContent = 'Error: ' + e.message;
    status.style.color = 'var(--red)';
  }
  btn.disabled = false;
  btn.textContent = 'Save Notes';
  setTimeout(() => { status.textContent = ''; }, 3000);
}

// Close modal on Escape
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// Stats
async function loadStats() {
  try {
    const [c, s, o, ppl] = await Promise.all([
      fetch(API+'/api/centers').then(r=>r.json()),
      fetch(API+'/api/segments').then(r=>r.json()),
      fetch(API+'/api/organizations').then(r=>r.json()),
      fetch(API+'/api/people/stats').then(r=>r.json()),
    ]);
    document.getElementById('stats').innerHTML = `
      <div class="stat">üè• Centers: <span>${c.count}</span></div>
      <div class="stat">üë• People: <span>${ppl.total}</span></div>
      <div class="stat">üó∫Ô∏è Segments: <span>${s.count}</span></div>
      <div class="stat">üè¢ Orgs: <span>${o.count}</span></div>
    `;
  } catch(e) {}
}

function esc(s) { if (!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// Map
var mapInstance = null;
var mapMarkers = [];
var mapData = [];
var mapCategoryColors = {
  'NCI-Designated Cancer Centers': '#e74c3c',
  'Academic Medical Center Cancer Programs': '#6c5ce7',
  'Large Community Oncology Practices': '#00cec9',
  'Hospital System Cancer Programs': '#fdcb6e',
  'Specialty/Boutique Cancer Centers': '#fd79a8'
};
var mapCategoryShort = {
  'NCI-Designated Cancer Centers': 'NCI-Designated',
  'Academic Medical Center Cancer Programs': 'Academic',
  'Large Community Oncology Practices': 'Community',
  'Hospital System Cancer Programs': 'Hospital System',
  'Specialty/Boutique Cancer Centers': 'Specialty/Boutique'
};
var mapCategoryEnabled = {};

function getCatColor(cat) {
  return mapCategoryColors[cat] || '#636e72';
}

function getMarkerRadius(onc) {
  if (!onc) return 5;
  var n = parseInt(String(onc).replace(/[^0-9]/g, ''), 10);
  if (isNaN(n) || n === 0) return 5;
  if (n < 10) return 5;
  if (n < 30) return 7;
  if (n < 80) return 9;
  if (n < 200) return 12;
  return 15;
}

function initMap() {
  if (mapInstance) return;
  mapInstance = L.map('mapContainer', { zoomControl: true }).setView([37.5, -96], 4);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap &copy; CARTO',
    maxZoom: 18
  }).addTo(mapInstance);
  loadMapData();
}

async function loadMapData() {
  var res = await fetch(API + '/api/centers/geo');
  var data = await res.json();
  mapData = data.centers;

  // Init category filters
  var cats = {};
  mapData.forEach(function(c) { cats[c.category] = true; });
  mapCategoryEnabled = cats;
  var filterDiv = document.getElementById('mapCategoryFilters');
  filterDiv.innerHTML = Object.keys(cats).map(function(cat) {
    var short = mapCategoryShort[cat] || cat;
    var color = getCatColor(cat);
    return '<label><input type="checkbox" checked onchange="toggleMapCategory(this,\'' + cat.replace(/'/g, "\\'") + '\')">' +
      '<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:' + color + '"></span> ' + esc(short) + '</label>';
  }).join('');

  applyMapFilters();
}

function toggleMapCategory(el, cat) {
  mapCategoryEnabled[cat] = el.checked;
  applyMapFilters();
}

function applyMapFilters() {
  if (!mapInstance) return;
  var stateFilter = document.getElementById('mapStateFilter').value;

  // Clear existing markers
  mapMarkers.forEach(function(m) { mapInstance.removeLayer(m); });
  mapMarkers = [];

  var filtered = mapData.filter(function(c) {
    if (!mapCategoryEnabled[c.category]) return false;
    if (stateFilter && c.state !== stateFilter) return false;
    return true;
  });

  filtered.forEach(function(c) {
    if (!c.latitude || !c.longitude) return;
    var marker = L.circleMarker([c.latitude, c.longitude], {
      radius: getMarkerRadius(c.est_oncologists),
      fillColor: getCatColor(c.category),
      color: '#fff',
      weight: 1,
      fillOpacity: 0.8
    });
    marker.bindTooltip(c.name, { direction: 'top', offset: [0, -6] });
    var popupHtml = '<strong>' + esc(c.name) + '</strong><br>' +
      esc(c.city) + ', ' + esc(c.state) + '<br>' +
      '<span style="color:' + getCatColor(c.category) + '">' + esc(mapCategoryShort[c.category] || c.category) + '</span><br>' +
      (c.ehr_vendor ? 'EHR: ' + esc(c.ehr_vendor) + '<br>' : '') +
      (c.est_oncologists ? 'Oncologists: ' + esc(c.est_oncologists) + '<br>' : '') +
      '<a href="#" onclick="closeMapPopup();openCenter(' + c.id + ');return false;">View Details</a>';
    marker.bindPopup(popupHtml);
    marker.addTo(mapInstance);
    mapMarkers.push(marker);
  });

  document.getElementById('mapTotal').textContent = filtered.length;
  updateMapAnalytics(filtered);
}

function closeMapPopup() {
  if (mapInstance) mapInstance.closePopup();
}

function updateMapAnalytics(data) {
  // State breakdown
  var states = {};
  data.forEach(function(c) { states[c.state] = (states[c.state] || 0) + 1; });
  var maxState = Math.max.apply(null, Object.values(states).concat([1]));
  document.getElementById('mapStateBreakdown').innerHTML = Object.entries(states)
    .sort(function(a, b) { return b[1] - a[1]; })
    .map(function(e) {
      return '<div class="map-bar"><span class="bar-label">' + esc(e[0]) + '</span>' +
        '<div class="bar-fill" style="width:' + Math.round(e[1] / maxState * 80) + 'px;background:var(--accent)"></div>' +
        '<span class="bar-count">' + e[1] + '</span></div>';
    }).join('');

  // Category breakdown
  var cats = {};
  data.forEach(function(c) { cats[c.category] = (cats[c.category] || 0) + 1; });
  var maxCat = Math.max.apply(null, Object.values(cats).concat([1]));
  document.getElementById('mapCatBreakdown').innerHTML = Object.entries(cats)
    .sort(function(a, b) { return b[1] - a[1]; })
    .map(function(e) {
      var short = mapCategoryShort[e[0]] || e[0];
      return '<div class="map-bar"><span class="bar-label">' + esc(short) + '</span>' +
        '<div class="bar-fill" style="width:' + Math.round(e[1] / maxCat * 60) + 'px;background:' + getCatColor(e[0]) + '"></div>' +
        '<span class="bar-count">' + e[1] + '</span></div>';
    }).join('');

  // EHR breakdown
  var ehrs = {};
  data.forEach(function(c) {
    var v = c.ehr_vendor || 'Unknown';
    // Normalize
    if (v.toLowerCase().indexOf('epic') >= 0) v = 'Epic';
    else if (v.toLowerCase().indexOf('cerner') >= 0) v = 'Cerner';
    else if (v.toLowerCase().indexOf('meditech') >= 0) v = 'MEDITECH';
    else if (v === '-' || v === '') v = 'Unknown';
    ehrs[v] = (ehrs[v] || 0) + 1;
  });
  var ehrSorted = Object.entries(ehrs).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 6);
  var maxEhr = ehrSorted.length > 0 ? ehrSorted[0][1] : 1;
  document.getElementById('mapEhrBreakdown').innerHTML = ehrSorted.map(function(e) {
    return '<div class="map-bar"><span class="bar-label">' + esc(e[0]) + '</span>' +
      '<div class="bar-fill" style="width:' + Math.round(e[1] / maxEhr * 60) + 'px;background:var(--green)"></div>' +
      '<span class="bar-count">' + e[1] + '</span></div>';
  }).join('');

  // 340B
  var total340 = data.length;
  var yes340 = data.filter(function(c) { return c.is_340b === 1; }).length;
  var pct = total340 > 0 ? Math.round(yes340 / total340 * 100) : 0;
  document.getElementById('map340b').innerHTML =
    '<div class="map-bar"><span class="bar-label">340B Enrolled</span>' +
    '<div class="bar-fill" style="width:' + pct + 'px;background:var(--green)"></div>' +
    '<span class="bar-count">' + pct + '%</span></div>' +
    '<div style="font-size:11px;color:var(--text2);margin-top:4px;">' + yes340 + ' of ' + total340 + ' centers</div>';
}

// --- People ---
function relevanceBadge(rel) {
  if (!rel) return '';
  var cls = rel.toLowerCase().replace(/\s+/g, '-');
  return '<span class="relevance-badge ' + cls + '">' + esc(rel) + '</span>';
}

async function loadPeople() {
  var p = new URLSearchParams();
  var role = document.getElementById('peopleRoleFilter').value;
  var dept = document.getElementById('peopleDeptFilter').value;
  var rel = document.getElementById('peopleRelFilter').value;
  var search = document.getElementById('peopleSearch').value;
  if (role) p.set('role_type', role);
  if (dept) p.set('department', dept);
  if (rel) p.set('relevance', rel);
  if (search) p.set('search', search);
  var res = await fetch(API + '/api/people?' + p);
  var data = await res.json();
  var tbody = document.getElementById('peopleBody');
  tbody.innerHTML = data.people.map(function(person) {
    var li = person.linkedin_url ? '<a href="' + esc(person.linkedin_url) + '" target="_blank" class="linkedin-link" onclick="event.stopPropagation()" title="LinkedIn">in</a>' : '';
    return '<tr onclick="openPerson(' + person.id + ')">' +
      '<td><strong style="color:var(--accent2)">' + esc(person.name) + '</strong></td>' +
      '<td>' + esc(person.title) + '</td>' +
      '<td>' + esc(person.organization) + '</td>' +
      '<td>' + esc(person.role_type) + '</td>' +
      '<td>' + esc(person.department) + '</td>' +
      '<td>' + relevanceBadge(person.relevance_to_risa) + '</td>' +
      '<td>' + li + '</td></tr>';
  }).join('');
  loadPeopleStats();
}

async function loadPeopleStats() {
  var res = await fetch(API + '/api/people/stats');
  var data = await res.json();
  document.getElementById('peopleTotalStat').textContent = data.total;
  document.getElementById('peopleDecisionStat').textContent = data.decision_makers;
  document.getElementById('peopleCentersStat').textContent = data.centers_covered;
}

async function openPerson(id) {
  var res = await fetch(API + '/api/people/' + id);
  var p = await res.json();
  document.getElementById('personModalName').textContent = p.name;
  document.getElementById('personModalSub').textContent = [p.title, p.organization].filter(Boolean).join(' - ');

  var v = function(val) { return val ? esc(String(val)) : '<span class="empty">Not available</span>'; };
  var centerLink = '';
  if (p.center_id) {
    centerLink = '<a href="#" onclick="closePersonModal();openCenter(' + p.center_id + ');return false;" style="color:var(--accent2)">View Center</a>';
  }

  document.getElementById('personModalBody').innerHTML =
    '<div class="detail-grid">' +
      '<div class="detail-item"><div class="label">Role Type</div><div class="value">' + v(p.role_type) + '</div></div>' +
      '<div class="detail-item"><div class="label">Department</div><div class="value">' + v(p.department) + '</div></div>' +
      '<div class="detail-item"><div class="label">Organization</div><div class="value">' + v(p.organization) + '</div></div>' +
      '<div class="detail-item"><div class="label">Relevance</div><div class="value">' + relevanceBadge(p.relevance_to_risa) + '</div></div>' +
      '<div class="detail-item"><div class="label">Email</div><div class="value">' + (p.email ? '<a href="mailto:' + esc(p.email) + '" style="color:var(--accent2)">' + esc(p.email) + '</a>' : '<span class="empty">Not available</span>') + '</div></div>' +
      '<div class="detail-item"><div class="label">Phone</div><div class="value">' + v(p.phone) + '</div></div>' +
      '<div class="detail-item"><div class="label">LinkedIn</div><div class="value">' + (p.linkedin_url ? '<a href="' + esc(p.linkedin_url) + '" target="_blank" style="color:var(--accent2)">Profile</a>' : '<span class="empty">Not available</span>') + '</div></div>' +
      '<div class="detail-item"><div class="label">Source</div><div class="value">' + v(p.source) + '</div></div>' +
      '<div class="detail-item"><div class="label">Last Contacted</div><div class="value">' + v(p.last_contacted) + '</div></div>' +
      '<div class="detail-item"><div class="label">Next Follow-up</div><div class="value">' + v(p.next_followup) + '</div></div>' +
      (centerLink ? '<div class="detail-item"><div class="label">Linked Center</div><div class="value">' + centerLink + '</div></div>' : '') +
    '</div>' +
    '<div class="detail-section">' +
      '<h3>üìù Notes</h3>' +
      '<textarea class="notes-textarea" id="personNotesArea" placeholder="Add notes...">' + esc(p.notes || '') + '</textarea>' +
      '<div class="notes-actions">' +
        '<button class="btn-save" onclick="savePersonNotes(' + p.id + ')">Save Notes</button>' +
        '<button class="btn-secondary" onclick="editPerson(' + p.id + ')" style="margin-left:auto;">Edit</button>' +
        '<button class="btn-danger" onclick="deletePerson(' + p.id + ')">Delete</button>' +
        '<span class="notes-status" id="personNotesStatus"></span>' +
      '</div>' +
    '</div>';

  document.getElementById('personModal').classList.remove('hidden');
}

function closePersonModal() {
  document.getElementById('personModal').classList.add('hidden');
}

async function savePersonNotes(id) {
  var notes = document.getElementById('personNotesArea').value;
  var status = document.getElementById('personNotesStatus');
  await fetch(API + '/api/people/' + id, {
    method: 'PUT', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({notes: notes})
  });
  status.textContent = '‚úì Saved';
  status.style.color = 'var(--green)';
  setTimeout(function() { status.textContent = ''; }, 3000);
}

async function deletePerson(id) {
  if (!confirm('Delete this person?')) return;
  await fetch(API + '/api/people/' + id, { method: 'DELETE' });
  closePersonModal();
  loadPeople();
}

async function editPerson(id) {
  closePersonModal();
  var res = await fetch(API + '/api/people/' + id);
  var p = await res.json();
  openPersonForm(p);
}

function openPersonForm(person) {
  var isEdit = person && person.id;
  document.getElementById('personFormTitle').textContent = isEdit ? 'Edit Person' : 'Add Person';
  document.getElementById('pf_edit_id').value = isEdit ? person.id : '';
  document.getElementById('pf_name').value = isEdit ? (person.name || '') : '';
  document.getElementById('pf_title').value = isEdit ? (person.title || '') : '';
  document.getElementById('pf_role_type').value = isEdit ? (person.role_type || '') : '';
  document.getElementById('pf_organization').value = isEdit ? (person.organization || '') : '';
  document.getElementById('pf_department').value = isEdit ? (person.department || '') : '';
  document.getElementById('pf_relevance').value = isEdit ? (person.relevance_to_risa || '') : '';
  document.getElementById('pf_email').value = isEdit ? (person.email || '') : '';
  document.getElementById('pf_phone').value = isEdit ? (person.phone || '') : '';
  document.getElementById('pf_linkedin').value = isEdit ? (person.linkedin_url || '') : '';
  document.getElementById('pf_source').value = isEdit ? (person.source || '') : '';
  document.getElementById('pf_last_contacted').value = isEdit ? (person.last_contacted || '') : '';
  document.getElementById('pf_next_followup').value = isEdit ? (person.next_followup || '') : '';
  document.getElementById('pf_notes').value = isEdit ? (person.notes || '') : '';
  document.getElementById('pf_center_id').value = isEdit ? (person.center_id || '') : '';
  // Load org suggestions
  fetch(API + '/api/centers?').then(function(r) { return r.json(); }).then(function(d) {
    var dl = document.getElementById('orgSuggestions');
    var seen = {};
    dl.innerHTML = d.centers.map(function(c) {
      if (seen[c.name]) return '';
      seen[c.name] = true;
      return '<option value="' + esc(c.name) + '">';
    }).join('');
  });
  document.getElementById('personFormModal').classList.remove('hidden');
}

function closePersonForm() {
  document.getElementById('personFormModal').classList.add('hidden');
}

async function savePerson() {
  var name = document.getElementById('pf_name').value.trim();
  if (!name) { alert('Name is required'); return; }
  var body = {
    name: name,
    title: document.getElementById('pf_title').value || null,
    role_type: document.getElementById('pf_role_type').value || null,
    organization: document.getElementById('pf_organization').value || null,
    department: document.getElementById('pf_department').value || null,
    relevance_to_risa: document.getElementById('pf_relevance').value || null,
    email: document.getElementById('pf_email').value || null,
    phone: document.getElementById('pf_phone').value || null,
    linkedin_url: document.getElementById('pf_linkedin').value || null,
    source: document.getElementById('pf_source').value || null,
    last_contacted: document.getElementById('pf_last_contacted').value || null,
    next_followup: document.getElementById('pf_next_followup').value || null,
    notes: document.getElementById('pf_notes').value || null
  };
  var centerId = document.getElementById('pf_center_id').value;
  if (centerId) body.center_id = parseInt(centerId);
  var editId = document.getElementById('pf_edit_id').value;
  if (editId) {
    await fetch(API + '/api/people/' + editId, {
      method: 'PUT', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });
  } else {
    await fetch(API + '/api/people', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });
  }
  closePersonForm();
  loadPeople();
}

// Load people linked to a center (for center detail modal)
async function loadCenterPeople(centerId, centerName) {
  var res = await fetch(API + '/api/people?center_id=' + centerId);
  var data = await res.json();
  if (data.count === 0) {
    return '<p style="color:var(--text2);font-size:13px;">No people linked to this center yet.</p>' +
      '<button class="btn-secondary" onclick="closeModal();openPersonFormForCenter(' + centerId + ',\'' + esc(centerName).replace(/'/g, "\\'") + '\')" style="margin-top:8px;padding:6px 12px;font-size:12px;">+ Add Person</button>';
  }
  var rows = data.people.map(function(p) {
    return '<tr style="cursor:pointer" onclick="closeModal();openPerson(' + p.id + ')">' +
      '<td>' + esc(p.name) + '</td><td>' + esc(p.title) + '</td><td>' + esc(p.role_type) + '</td>' +
      '<td>' + relevanceBadge(p.relevance_to_risa) + '</td></tr>';
  }).join('');
  return '<table class="center-people-table"><thead><tr><th>Name</th><th>Title</th><th>Role</th><th>Relevance</th></tr></thead><tbody>' + rows + '</tbody></table>' +
    '<button class="btn-secondary" onclick="closeModal();openPersonFormForCenter(' + centerId + ',\'' + esc(centerName).replace(/'/g, "\\'") + '\')" style="margin-top:8px;padding:6px 12px;font-size:12px;">+ Add Person</button>';
}

function openPersonFormForCenter(centerId, centerName) {
  openPersonForm();
  document.getElementById('pf_center_id').value = centerId;
  document.getElementById('pf_organization').value = centerName;
}

// ========== WORKFLOWS ==========
let currentWfView = 'table';
const COMPLEXITY_COLORS = {High:'var(--red)', Medium:'var(--orange)', Low:'var(--green)'};
const STAGE_COLORS = ['','#e74c3c','#e67e22','#f1c40f','#2ecc71','#1abc9c','#3498db','#9b59b6','#95a5a6','#7f8c8d'];

async function loadWorkflowStats() {
  const res = await fetch(API + '/api/workflows/stats');
  const d = await res.json();
  document.getElementById('wfTotal').textContent = d.total;
  document.getElementById('wfSteps').textContent = d.total_steps;
  document.getElementById('wfAutoPct').textContent = d.automation_pct + '%';
  document.getElementById('wfAvgBn').textContent = d.avg_bottleneck + '/5';
}

async function loadWorkflows() {
  const params = new URLSearchParams();
  const dept = document.getElementById('wfDeptFilter').value;
  const stage = document.getElementById('wfStageFilter').value;
  const complexity = document.getElementById('wfComplexFilter').value;
  const center = document.getElementById('wfCenterFilter').value;
  const search = document.getElementById('wfSearch').value;
  if (dept) params.set('department', dept);
  if (stage) params.set('stage', stage);
  if (complexity) params.set('complexity', complexity);
  if (center) params.set('center', center);
  if (search) params.set('search', search);
  const res = await fetch(API + '/api/workflows?' + params);
  const data = await res.json();
  document.getElementById('wfCount').textContent = data.count + ' workflows';
  renderWfTable(data.workflows);
  renderWfCards(data.workflows);
  renderWfJourney(data.workflows);
}

function renderWfTable(wfs) {
  const body = document.getElementById('wfBody');
  body.innerHTML = wfs.map(w => {
    const bnBar = '‚ñà'.repeat(w.bottleneck_severity) + '‚ñë'.repeat(5 - w.bottleneck_severity);
    const cColor = COMPLEXITY_COLORS[w.complexity] || 'var(--text2)';
    return '<tr onclick="openWfDetail(\'' + w.workflow_id + '\')">' +
      '<td style="color:var(--accent2);font-weight:600;">' + w.workflow_id + '</td>' +
      '<td style="color:var(--text);max-width:280px;">' + w.name + '</td>' +
      '<td>' + w.department + '</td>' +
      '<td><span style="color:' + STAGE_COLORS[w.patient_journey_stage] + ';">' + w.patient_journey_stage + '</span> ' + w.stage_name + '</td>' +
      '<td>' + w.centers_applicable + '</td>' +
      '<td style="color:' + cColor + ';">' + w.complexity + '</td>' +
      '<td style="font-family:monospace;font-size:11px;letter-spacing:1px;color:' + (w.bottleneck_severity >= 4 ? 'var(--red)' : w.bottleneck_severity >= 2 ? 'var(--orange)' : 'var(--green)') + ';">' + bnBar + '</td>' +
      '<td>' + (w.avg_time_minutes || '-') + '</td>' +
      '</tr>';
  }).join('');
}

function renderWfCards(wfs) {
  const grid = document.getElementById('wfCardsGrid');
  grid.innerHTML = wfs.map(w => {
    const cColor = COMPLEXITY_COLORS[w.complexity] || 'var(--text2)';
    return '<div class="card" style="cursor:pointer;" onclick="openWfDetail(\'' + w.workflow_id + '\')">' +
      '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">' +
        '<h4 style="flex:1;">' + w.workflow_id + ' - ' + w.name + '</h4>' +
        '<span style="color:' + cColor + ';font-size:11px;font-weight:600;white-space:nowrap;margin-left:8px;">' + w.complexity + '</span>' +
      '</div>' +
      '<p style="margin-bottom:8px;">' + (w.description || '').substring(0, 150) + '...</p>' +
      '<div style="display:flex;flex-wrap:wrap;gap:4px;">' +
        '<span class="tag">' + w.department + '</span>' +
        '<span class="tag">Stage ' + w.patient_journey_stage + '</span>' +
        '<span class="tag">' + w.centers_applicable + '</span>' +
        '<span class="tag" style="background:rgba(255,118,117,0.15);color:var(--red);">Bottleneck: ' + w.bottleneck_severity + '/5</span>' +
      '</div>' +
    '</div>';
  }).join('');
}

function renderWfJourney(wfs) {
  const map = document.getElementById('wfJourneyMap');
  const stages = {};
  wfs.forEach(w => {
    const s = w.patient_journey_stage;
    if (!stages[s]) stages[s] = {name: w.stage_name, workflows: []};
    stages[s].workflows.push(w);
  });
  let html = '<div style="display:flex;gap:12px;overflow-x:auto;padding-bottom:12px;">';
  for (let s = 1; s <= 9; s++) {
    if (!stages[s]) continue;
    const st = stages[s];
    html += '<div style="min-width:220px;max-width:280px;flex-shrink:0;">' +
      '<div style="background:' + STAGE_COLORS[s] + ';color:#fff;padding:10px 14px;border-radius:8px 8px 0 0;font-size:13px;font-weight:600;">Stage ' + s + ': ' + st.name + ' <span style="opacity:0.7;">(' + st.workflows.length + ')</span></div>' +
      '<div style="background:var(--bg3);border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;padding:8px;max-height:500px;overflow-y:auto;">';
    st.workflows.forEach(w => {
      const cColor = COMPLEXITY_COLORS[w.complexity] || 'var(--text2)';
      html += '<div style="padding:8px;margin-bottom:6px;background:var(--bg2);border-radius:6px;border-left:3px solid ' + cColor + ';cursor:pointer;font-size:11px;" onclick="openWfDetail(\'' + w.workflow_id + '\')">' +
        '<div style="color:var(--accent2);font-weight:600;">' + w.workflow_id + '</div>' +
        '<div style="color:var(--text);margin-top:2px;">' + w.name + '</div>' +
        '<div style="color:var(--text2);margin-top:4px;">' + w.department + ' - ' + w.centers_applicable + '</div>' +
      '</div>';
    });
    html += '</div></div>';
  }
  html += '</div>';
  map.innerHTML = html;
}

function setWfView(v) {
  currentWfView = v;
  ['table','cards','journey'].forEach(x => {
    document.getElementById('wf' + x.charAt(0).toUpperCase() + x.slice(1) + 'View').classList.toggle('hidden', x !== v);
    const btn = document.getElementById('wfView' + x.charAt(0).toUpperCase() + x.slice(1));
    if (x === v) { btn.style.background = 'var(--accent)'; btn.style.color = '#fff'; btn.style.border = 'none'; }
    else { btn.style.background = 'var(--bg3)'; btn.style.color = 'var(--text2)'; btn.style.border = '1px solid var(--border)'; }
  });
}

async function openWfDetail(wfId) {
  const res = await fetch(API + '/api/workflows/' + wfId);
  const w = await res.json();
  document.getElementById('wfModalName').textContent = w.workflow_id + ' - ' + w.name;
  document.getElementById('wfModalSub').textContent = w.department + ' | Stage ' + w.patient_journey_stage + ': ' + w.stage_name + ' | ' + w.centers_applicable;

  let html = '<div class="detail-grid">' +
    '<div class="detail-item full"><div class="label">Description</div><div class="value">' + (w.description || '-') + '</div></div>' +
    '<div class="detail-item"><div class="label">Complexity</div><div class="value" style="color:' + (COMPLEXITY_COLORS[w.complexity] || 'var(--text)') + ';font-weight:600;">' + (w.complexity || '-') + '</div></div>' +
    '<div class="detail-item"><div class="label">Avg Time</div><div class="value">' + (w.avg_time_minutes || '-') + ' minutes</div></div>' +
    '<div class="detail-item"><div class="label">Bottleneck Severity</div><div class="value">' + renderBottleneck(w.bottleneck_severity) + '</div></div>' +
    '<div class="detail-item"><div class="label">Centers</div><div class="value">' + (w.centers_applicable || '-') + '</div></div>' +
    '<div class="detail-item full"><div class="label">Pain Points</div><div class="value" style="color:var(--red);font-size:13px;line-height:1.6;">' + (w.pain_points || '-') + '</div></div>' +
    '<div class="detail-item full"><div class="label">RISA Opportunity</div><div class="value" style="color:var(--green);font-size:13px;line-height:1.6;">' + (w.risa_opportunity || '-') + '</div></div>' +
  '</div>';

  // Steps
  if (w.steps && w.steps.length) {
    html += '<div class="detail-section"><h3>Workflow Steps</h3>' +
      '<div style="position:relative;padding-left:24px;">';
    w.steps.forEach((s, i) => {
      const isLast = i === w.steps.length - 1;
      const bottleStyle = s.is_bottleneck ? 'border-color:var(--red);' : '';
      const autoIcon = s.is_automatable ? ' <span title="Automatable by RISA" style="color:var(--green);font-size:10px;">ü§ñ</span>' : '';
      html += '<div style="position:relative;margin-bottom:' + (isLast ? '0' : '16px') + ';">' +
        '<div style="position:absolute;left:-24px;top:0;width:20px;height:20px;border-radius:50%;background:' + (s.is_bottleneck ? 'var(--red)' : 'var(--accent)') + ';color:#fff;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;">' + s.step_number + '</div>' +
        (isLast ? '' : '<div style="position:absolute;left:-15px;top:20px;bottom:-16px;width:2px;background:var(--border);"></div>') +
        '<div style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 14px;' + bottleStyle + '">' +
          '<div style="font-size:13px;color:var(--text);font-weight:500;">' + s.description + autoIcon + '</div>' +
          '<div style="display:flex;gap:12px;margin-top:6px;font-size:11px;color:var(--text2);">' +
            '<span>üë§ ' + s.actor + '</span>' +
            '<span>üíª ' + s.system_used + '</span>' +
            '<span>‚è± ' + s.avg_time_minutes + ' min</span>' +
            (s.is_bottleneck ? '<span style="color:var(--red);">üî¥ Bottleneck</span>' : '') +
          '</div>' +
        '</div>' +
      '</div>';
    });
    html += '</div></div>';
  }

  // Stakeholders
  if (w.stakeholders && w.stakeholders.length) {
    html += '<div class="detail-section"><h3>Key Stakeholders</h3>' +
      '<table class="center-people-table"><thead><tr><th>Role</th><th>Responsibility</th><th>Authority</th></tr></thead><tbody>';
    w.stakeholders.forEach(s => {
      const authColor = s.decision_authority === 'Approver' ? 'var(--red)' : s.decision_authority === 'Executor' ? 'var(--accent2)' : 'var(--text2)';
      html += '<tr><td style="color:var(--text);font-weight:500;">' + s.role_name + '</td>' +
        '<td>' + s.responsibility + '</td>' +
        '<td style="color:' + authColor + ';">' + s.decision_authority + '</td></tr>';
    });
    html += '</tbody></table></div>';
  }

  // Notes
  html += '<div class="detail-section"><h3>Notes</h3>' +
    '<textarea class="notes-textarea" id="wfNotesArea" placeholder="Add notes about this workflow...">' + esc(w.notes || '') + '</textarea>' +
    '<div class="notes-actions">' +
      '<button class="btn-save" onclick="saveWfNotes(\'' + w.workflow_id + '\')">Save Notes</button>' +
      '<span class="notes-status" id="wfNotesStatus"></span>' +
    '</div></div>';

  document.getElementById('wfModalBody').innerHTML = html;
  document.getElementById('wfModal').classList.remove('hidden');
}

async function saveWfNotes(wfId) {
  const notes = document.getElementById('wfNotesArea').value;
  const status = document.getElementById('wfNotesStatus');
  const res = await fetch(API + '/api/workflows/' + wfId + '/notes', {
    method: 'PUT', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({notes: notes})
  });
  const data = await res.json();
  if (data.ok) {
    status.textContent = '‚úì Saved'; status.style.color = 'var(--green)';
  } else {
    status.textContent = 'Error'; status.style.color = 'var(--red)';
  }
  setTimeout(() => { status.textContent = ''; }, 3000);
}

function renderBottleneck(severity) {
  let html = '';
  for (let i = 1; i <= 5; i++) {
    const color = i <= severity ? (severity >= 4 ? 'var(--red)' : severity >= 2 ? 'var(--orange)' : 'var(--green)') : 'var(--bg4)';
    html += '<span style="display:inline-block;width:16px;height:16px;border-radius:3px;background:' + color + ';margin-right:3px;"></span>';
  }
  return html + ' <span style="font-size:12px;color:var(--text2);">(' + severity + '/5)</span>';
}

function closeWfModal() { document.getElementById('wfModal').classList.add('hidden'); }

// Init
loadCenters();
loadSegments();
loadOrgs();
loadStats();
</script>
</body>
</html>
